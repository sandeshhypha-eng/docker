name: Python CI/CD with DAST, Docker

on:
  workflow_dispatch:
  pull_request:

jobs:

          # ----------------------------
          # Explanation of ZAP parameters
          #
          # zap-baseline.py:
          #   - Does NOT attack the site aggressively
          #   - Performs PASSIVE security tests only
          #   - Safe for CI/CD pipelines
          #
          # Flags:
          # -t <URL>
          #     Target to scan
          #
          # -r zap_report.html
          #     Human-readable HTML report
          #
          # --exit-code-ignore 2
          #     ZAP returns exit code 2 when warnings exist
          #     (like missing security headers → harmless)
          #
          #     This prevents the CI pipeline from failing.
          #
          # --auto
          #     Skip prompts and run in full auto mode
          #
          # The reports are stored in /zap/wrk inside container,
          # mapped to $GITHUB_WORKSPACE/zap in GitHub Actions.
          # ----------------------------

      # Upload ZAP report artifacts (HTML, log files, etc.)
  dast:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # Start Flask App
      - name: Start Flask App
        run: |
          echo "Starting Flask app..."
          python app.py > /tmp/flask.log 2>&1 &
          echo "FLASK_PID=$!" >> $GITHUB_ENV
          sleep 3

      # Health Check
      - name: Health Check
        run: |
          echo "Checking Flask..."
          for i in {1..10}; do
            if curl -s http://localhost:5000/ >/dev/null; then
              echo "Flask is running."
              exit 0
            fi
            echo "Retrying..."
            sleep 2
          done
          echo "Flask failed to start"
          cat /tmp/flask.log
          exit 1

      # Show Flask Logs
      - name: Show Flask Logs
        if: always()
        run: cat /tmp/flask.log || true

      # Pull ZAP
      - name: Pull ZAP Image
        run: docker pull ghcr.io/zaproxy/zaproxy:stable

      # Create report directory
      - name: Prepare ZAP Reports Dir
        run: |
          mkdir -p zap-reports
          chmod 777 zap-reports

      # Run ZAP Baseline – FIXED PATHS
      - name: Run ZAP DAST Scan
        run: |
          docker run --rm \
            --network host \
            -v $GITHUB_WORKSPACE/zap-reports:/zap/wrk \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
            -t http://localhost:5000 \
            -r zap_baseline_report.html \
            -J zap_baseline_report.json \
            -x zap_baseline_report.xml \
            --auto

      - name: List ZAP Report Files
        if: always()
        run: ls -l zap-reports

      - name: Upload ZAP Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-scan-reports
          path: zap-reports/

      # Stop Flask
      - name: Stop Flask App
        if: always()
        run: |
          if [ -n "$FLASK_PID" ]; then kill $FLASK_PID || true; fi


  # ---------------------------
  # Python Build & Tests
  # ---------------------------
  build:
    runs-on: ubuntu-latest
    needs: dast

    steps:
      - uses: actions/checkout@v2

      - uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run Tests
        run: |
          if [ -d tests ]; then pytest; else echo "No tests found"; fi


  # ---------------------------
  # Docker Build + Trivy Scan
  # ---------------------------
  docker:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v2

      - name: Build Docker Image
        run: docker build -t sandesh/flask-app:latest .

      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          wget -qO- https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb stable main | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Scan Docker Image
        run: trivy image --exit-code 1 --severity HIGH,CRITICAL sandesh/flask-app:latest

